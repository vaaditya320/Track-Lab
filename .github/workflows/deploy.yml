name: Deploy to EC2

on:
  push:
    branches:
      - main  # Trigger on push to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH key
      run: |
        echo "${{ secrets.PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem

    - name: Deploy to EC2
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        USER: ${{ secrets.USER }}
        PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      run: |
        ssh -o StrictHostKeyChecking=no -i private_key.pem $USER@$SERVER_IP << 'EOF'
          # Ensure projects directory exists
          mkdir -p ~/projects
          cd ~/projects

          # Clone the repository if it doesn't exist
          if [ ! -d "Track-Lab" ]; then
            git clone https://github.com/vaaditya320/Track-Lab.git
          fi

          # Navigate to the repository
          cd Track-Lab

          # Pull latest changes
          git pull origin main

          # Remove old build
          rm -rf .next

          # Set up environment variables
          cat <<EOT > .env
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}
          NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
          EOT

          # Install dependencies
          npm install --max-old-space-size=512

          # Build the application
          npm run build

          # Restart the application on port 5090
          nohup npm start -- -p 5090 > nextjs.log 2>&1 &
        EOF
