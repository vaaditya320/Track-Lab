name: Deploy to EC2

on:
  push:
    branches:
      - main  # You can change this to any branch you'd like to trigger from

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH key
      run: |
        echo "${{ secrets.PRIVATE_KEY }}" > private_key.pem
        chmod 600 private_key.pem

    - name: Deploy to EC2
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        USER: ${{ secrets.USER }}
        PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      run: |
        # Connect to EC2, clean the old .next build, update the .env file with the secrets, install dependencies, build and start the app
        ssh -i private_key.pem $USER@$SERVER_IP "
          cd /var/www/nextjs-app &&
          rm -rf .next &&  # Remove old .next build
          echo 'DATABASE_URL=${{ secrets.DATABASE_URL }}' > .env &&
          echo 'GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}' >> .env &&
          echo 'GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}' >> .env &&
          echo 'NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}' >> .env &&
          echo 'GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}' >> .env &&
          echo 'NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}' >> .env &&
          npm install --max-old-space-size=512 &&
          npm run build &&
          sudo systemctl reload nginx &&
          nohup npm start -- -p 5090 > nextjs.log 2>&1 &
        "
